{% extends "base.html" %}

{% block title %}Dashboard - Secure Chat{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> Online Users</h5>
            </div>
            <div class="card-body">
                <div id="online-users">
                    {% for user in online_users %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <span>
                            <i class="fas fa-circle online"></i> {{ user }}
                        </span>
                        <a href="{{ url_for('chat', recipient=user) }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-comments"></i> Chat
                        </a>
                    </div>
                    {% endfor %}
                    
                    {% if not online_users %}
                    <p class="text-muted">No users online</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-key"></i> Your Security Status</h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <i class="fas fa-shield-alt text-success"></i> RSA Keys Generated
                </div>
                <div class="mb-2">
                    <i class="fas fa-lock text-success"></i> End-to-End Encryption Ready
                </div>
                <div>
                    <i class="fas fa-certificate text-info"></i> TLS Connection Secured
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-home"></i> Welcome, {{ user.username }}!</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <h6><i class="fas fa-info-circle"></i> How Secure Chat Works:</h6>
                    <ul class="mb-0">
                        <li><strong>Registration:</strong> RSA key pairs are automatically generated</li>
                        <li><strong>Encryption:</strong> Messages are encrypted with recipient's public key</li>
                        <li><strong>Decryption:</strong> Only recipient can decrypt with their private key</li>
                        <li><strong>Transport:</strong> All communication secured with TLS</li>
                        <li><strong>Storage:</strong> Only encrypted messages are stored in database</li>
                    </ul>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6><i class="fas fa-comments text-primary"></i> Start Chatting</h6>
                                <p class="small">Select a user from the online list to start a secure conversation</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6><i class="fas fa-eye text-info"></i> Encryption Visibility</h6>
                                <p class="small">Watch real-time encryption/decryption status in chat</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    
    // Handle initial list of online users
    socket.on('online_users', function(data) {
        const onlineUsers = document.getElementById('online-users');
        const currentUser = '{{ user.username }}';
        
        // Clear existing online users (except the current user)
        onlineUsers.innerHTML = '';
        
        // Add each online user to the list
        data.users.forEach(function(username) {
            if (username !== currentUser) {
                addUserToOnlineList(username, true);
            }
        });
    });
    
    // Handle user status updates
    socket.on('user_status', function(data) {
        updateUserStatus(data.username, data.status === 'online');
    });
    
    function addUserToOnlineList(username, isOnline) {
        const onlineUsers = document.getElementById('online-users');
        const existingUser = document.querySelector(`#online-users [data-username="${username}"]`);
        
        if (existingUser) {
            // Update existing user status
            const icon = existingUser.querySelector('.fa-circle');
            icon.className = `fas fa-circle ${isOnline ? 'online' : 'offline'}`;
            existingUser.style.display = isOnline ? 'flex' : 'none';
        } else if (isOnline) {
            // Add new user to the list
            const userElement = document.createElement('div');
            userElement.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
            userElement.dataset.username = username;
            userElement.innerHTML = `
                <span>
                    <i class="fas fa-circle ${isOnline ? 'online' : 'offline'}"></i> ${username}
                </span>
                <a href="/chat/${username}" class="btn btn-sm btn-primary">
                    <i class="fas fa-comments"></i> Chat
                </a>
            `;
            onlineUsers.prepend(userElement);
        }
        
        // Update the "no users online" message
        updateNoUsersMessage();
    }
    
    function updateUserStatus(username, isOnline) {
        const userElement = document.querySelector(`#online-users [data-username="${username}"]`);
        
        if (isOnline) {
            addUserToOnlineList(username, true);
        } else if (userElement) {
            userElement.remove();
            updateNoUsersMessage();
        }
    }
    
    function updateNoUsersMessage() {
        const onlineUsers = document.getElementById('online-users');
        const noUsersMessage = document.querySelector('#online-users .no-users-message');
        const hasOnlineUsers = document.querySelectorAll('#online-users > [data-username]').length > 0;
        
        if (!hasOnlineUsers && !noUsersMessage) {
            const message = document.createElement('p');
            message.className = 'text-muted no-users-message';
            message.textContent = 'No users online';
            onlineUsers.appendChild(message);
        } else if (hasOnlineUsers && noUsersMessage) {
            noUsersMessage.remove();
        }
    }
    
    // Initialize the no users message if needed
    document.addEventListener('DOMContentLoaded', function() {
        updateNoUsersMessage();
    });
</script>
{% endblock %}
