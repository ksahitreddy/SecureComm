{% extends "base.html" %}

{% block title %}Chat with {{ recipient }} - Secure Chat{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>
                    <i class="fas fa-comments"></i> 
                    Chat with {{ recipient }}
                    <span id="recipient-status" class="user-status ms-2">
                        <i class="fas fa-circle"></i> Status Unknown
                    </span>
                </h5>
                <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
            
            <div id="chat-messages" class="chat-container">
                <!-- Messages will be loaded here -->
                <div id="message-list"></div>
            </div>
            
            <div class="card-footer">
                <form id="message-form" class="d-flex gap-2">
                    <input type="text" id="message-input" class="form-control" 
                           placeholder="Type your message... (max 150 chars for RSA)" 
                           maxlength="150" required>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </form>
                <small class="text-muted">Messages are encrypted end-to-end with RSA</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-shield-alt"></i> Encryption Status</h6>
            </div>
            <div class="card-body">
                <div id="encryption-log" style="height: 400px; overflow-y: auto;">
                    <div class="encryption-log">
                        <i class="fas fa-info-circle"></i> Ready for secure messaging
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-chart-line"></i> Session Stats</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h5 text-success" id="messages-sent">0</div>
                        <small>Sent</small>
                    </div>
                    <div class="col-6">
                        <div class="h5 text-info" id="messages-received">0</div>
                        <small>Received</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    const currentUser = '{{ current_user }}';
    const recipient = '{{ recipient }}';
    let messagesSent = 0;
    let messagesReceived = 0;
    
    // DOM elements
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const messageList = document.getElementById('message-list');
    const encryptionLog = document.getElementById('encryption-log');
    const chatContainer = document.getElementById('chat-messages');
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadChatHistory();
        messageInput.focus();
    });
    
    // Handle message form submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        
        if (message) {
            sendMessage(message);
            messageInput.value = '';
        }
    });
    
    function sendMessage(message) {
        // Add message to UI immediately (optimistic update)
        addMessageToUI(currentUser, message, 'sent', new Date().toISOString(), true);
        
        // Send to server for encryption and delivery
        socket.emit('send_message', {
            recipient: recipient,
            message: message
        });
        
        addEncryptionLog('üîí Encrypting message with ' + recipient + '\'s public key...', 'info');
    }
    
    function addMessageToUI(sender, content, type, timestamp, isPlaintext = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble message-${type}`;
        
        const isSent = (sender === currentUser);
        const displayContent = isPlaintext ? content : '[Encrypted Message - Click to decrypt]';
        
        messageDiv.innerHTML = `
            <div class="message-content" ${!isPlaintext && !isSent ? 'style="cursor: pointer;"' : ''}>
                ${displayContent}
            </div>
            <div class="message-meta">
                <small class="text-muted">
                    ${isSent ? 'You' : sender} ‚Ä¢ ${formatTime(timestamp)}
                    ${!isPlaintext ? '<i class="fas fa-lock ms-1"></i>' : ''}
                </small>
            </div>
        `;
        
        // Add click handler for encrypted received messages
        if (!isPlaintext && !isSent) {
            messageDiv.addEventListener('click', function() {
                decryptMessage(messageDiv, content, generateMessageId());
            });
        }
        
        messageList.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function decryptMessage(messageElement, encryptedContent, messageId) {
        addEncryptionLog('üîì Decrypting message with your private key...', 'info');
        
        socket.emit('decrypt_message', {
            encrypted_content: encryptedContent,
            message_id: messageId
        });
        
        // Store reference for later update
        messageElement.dataset.messageId = messageId;
    }
    
    function addEncryptionLog(message, type = 'info') {
        const logDiv = document.createElement('div');
        logDiv.className = `encryption-log alert-${type}`;
        logDiv.innerHTML = `
            <div class="d-flex justify-content-between">
                <span>${message}</span>
                <small>${new Date().toLocaleTimeString()}</small>
            </div>
        `;
        
        encryptionLog.appendChild(logDiv);
        encryptionLog.scrollTop = encryptionLog.scrollHeight;
    }
    
    function updateStats() {
        document.getElementById('messages-sent').textContent = messagesSent;
        document.getElementById('messages-received').textContent = messagesReceived;
    }
    
    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString();
    }
    
    function generateMessageId() {
        return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    function loadChatHistory() {
        // Load existing messages from template data
        const messages = {{ messages | tojson}};
        
        messages.reverse().forEach(msg => {
            const isSent = (msg.sender === currentUser);
            addMessageToUI(
                msg.sender, 
                msg.encrypted_content, 
                isSent ? 'sent' : 'received', 
                msg.timestamp,
                false // Always encrypted in history
            );
        });
    }
    
    // Socket event handlers
    socket.on('encryption_status', function(data) {
        addEncryptionLog(
            `‚úÖ Message encrypted successfully (${data.original_length} ‚Üí ${data.encrypted_length} chars)`, 
            'success'
        );
    });
    
    socket.on('message_sent', function(data) {
        messagesSent++;
        updateStats();
        addEncryptionLog('üì§ Encrypted message sent to ' + data.recipient, 'success');
    });
    
    socket.on('new_message', function(data) {
        messagesReceived++;
        updateStats();
        
        addMessageToUI(
            data.sender, 
            data.encrypted_content, 
            'received', 
            data.timestamp,
            false
        );
        
        addEncryptionLog('üì• Encrypted message received from ' + data.sender, 'info');
    });
    
    socket.on('decryption_status', function(data) {
        addEncryptionLog(
            `üîì Message decrypted successfully (${data.encrypted_length} ‚Üí ${data.decrypted_length} chars)`, 
            'success'
        );
    });
    
    socket.on('message_decrypted', function(data) {
        // Find the message element and update it
        const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
        if (messageElement) {
            const contentDiv = messageElement.querySelector('.message-content');
            contentDiv.textContent = data.content;
            contentDiv.style.cursor = 'default';
            
            // Remove lock icon
            const lockIcon = messageElement.querySelector('.fa-lock');
            if (lockIcon) lockIcon.remove();
        }
    });
    
    socket.on('user_status', function(data) {
        if (data.username === recipient) {
            const statusElement = document.getElementById('recipient-status');
            statusElement.innerHTML = `<i class="fas fa-circle ${data.status}"></i> ${data.status}`;
        }
    });
    
    socket.on('error', function(data) {
        addEncryptionLog('‚ùå Error: ' + data.message, 'danger');
        console.error('Socket error:', data.message);
    });
    
    // Handle connection events
    socket.on('connect', function() {
        addEncryptionLog('üîå Connected to secure server', 'success');
    });
    
    socket.on('disconnect', function() {
        addEncryptionLog('üîå Disconnected from server', 'warning');
    });
</script>
{% endblock %}
